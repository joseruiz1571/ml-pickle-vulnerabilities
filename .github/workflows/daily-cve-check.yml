name: Daily CVE Monitor

on:
  schedule:
    # Run at 6 AM UTC daily
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      days_back:
        description: 'Number of days to look back'
        required: false
        default: '7'

jobs:
  check-cves:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      # Step 1: Fetch CVEs as JSON for processing
      - name: Fetch new CVEs
        id: fetch
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          DAYS=${{ github.event.inputs.days_back || '7' }}
          python scripts/fetch_nvd.py --days $DAYS --output json > cves.json

          # Count CVEs
          CVE_COUNT=$(python -c "import json; data=json.load(open('cves.json')); print(len(data))")
          echo "cve_count=$CVE_COUNT" >> $GITHUB_OUTPUT

          if [ "$CVE_COUNT" -eq "0" ]; then
            echo "has_cves=false" >> $GITHUB_OUTPUT
            echo "No CVEs found"
          else
            echo "has_cves=true" >> $GITHUB_OUTPUT
            echo "Found $CVE_COUNT CVEs"
          fi

      # Step 2: Check for duplicates and categorize by severity
      - name: Check duplicates and categorize
        if: steps.fetch.outputs.has_cves == 'true'
        id: categorize
        run: |
          # Check duplicates and get new CVEs
          python scripts/generate_cve_entry.py \
            --input cves.json \
            --check-duplicates \
            --vulnerabilities-dir vulnerabilities/ \
            > dedup_result.json

          # Extract counts
          NEW_COUNT=$(python -c "import json; print(json.load(open('dedup_result.json'))['total_new'])")
          echo "new_cve_count=$NEW_COUNT" >> $GITHUB_OUTPUT

          if [ "$NEW_COUNT" -eq "0" ]; then
            echo "No new CVEs after deduplication"
            echo "has_new_cves=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_new_cves=true" >> $GITHUB_OUTPUT

          # Categorize by severity
          python -c "
          import json

          result = json.load(open('dedup_result.json'))
          cves = result['new_cves']

          critical = []
          high = []
          lower = []

          for cve in cves:
              cvss = cve.get('cvss_score')
              try:
                  score = float(cvss) if cvss and cvss != 'Unknown' else 0
                  if score >= 9.0:
                      critical.append(cve)
                  elif score >= 7.0:
                      high.append(cve)
                  else:
                      lower.append(cve)
              except (ValueError, TypeError):
                  lower.append(cve)

          # Save categorized CVEs
          json.dump(critical + high, open('critical_high_cves.json', 'w'))
          json.dump(lower, open('lower_cves.json', 'w'))

          # Output counts
          print(f'critical_count={len(critical)}')
          print(f'high_count={len(high)}')
          print(f'lower_count={len(lower)}')
          print(f'has_critical_high={\"true\" if (critical or high) else \"false\"}')
          print(f'has_lower={\"true\" if lower else \"false\"}')

          # Print CVE IDs for summary
          if critical:
              print(f'critical_ids={[c[\"id\"] for c in critical]}')
          if high:
              print(f'high_ids={[c[\"id\"] for c in high]}')
          " >> $GITHUB_OUTPUT

      # Step 3: Generate CVE files for critical/high severity
      - name: Generate CVE files
        if: steps.categorize.outputs.has_critical_high == 'true'
        id: generate
        run: |
          python scripts/generate_cve_entry.py \
            --input critical_high_cves.json \
            --output-dir ./vulnerabilities \
            --vulnerabilities-dir ./vulnerabilities \
            --update-index \
            > generate_result.json

          echo "Generated files:"
          cat generate_result.json

      # Step 4: Create Pull Request for critical/high CVEs
      - name: Create Pull Request
        if: steps.categorize.outputs.has_critical_high == 'true'
        uses: peter-evans/create-pull-request@v7
        id: create-pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Add new critical/high severity CVEs

            Auto-generated from NVD scan.
            Critical: ${{ steps.categorize.outputs.critical_count }}
            High: ${{ steps.categorize.outputs.high_count }}
          title: "[AUTO] New CVEs: ${{ steps.categorize.outputs.critical_count }} critical, ${{ steps.categorize.outputs.high_count }} high"
          body: |
            ## Automated CVE Addition

            This PR adds newly discovered CVEs with CVSS >= 7.0.

            ### Summary
            - **Critical (CVSS 9.0+):** ${{ steps.categorize.outputs.critical_count }}
            - **High (CVSS 7.0-8.9):** ${{ steps.categorize.outputs.high_count }}

            ### Review Checklist
            - [ ] Verify CVE relevance to pickle deserialization
            - [ ] Review generated summaries for accuracy
            - [ ] Add technical details if available
            - [ ] Check index.md updates are correct

            ---
            *Generated by Daily CVE Monitor workflow*
            *Run: ${{ github.run_id }}*
          branch: auto/cve-update-${{ github.run_id }}
          labels: |
            automated
            needs-review
            cve-addition

      # Step 5: Send Slack alert for critical CVEs
      - name: Send Slack alert for critical
        if: steps.categorize.outputs.critical_count != '0' && steps.categorize.outputs.critical_count != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping alert"
            exit 0
          fi

          CRITICAL_COUNT=${{ steps.categorize.outputs.critical_count }}
          PR_URL="${{ steps.create-pr.outputs.pull-request-url }}"

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ðŸš¨ CRITICAL CVE Alert\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*${CRITICAL_COUNT} Critical CVE(s)* detected (CVSS 9.0+)\\n\\nNew pickle deserialization vulnerabilities require immediate review.\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Severity:*\\nCritical\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Count:*\\n${CRITICAL_COUNT}\"
                    }
                  ]
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"Review PR\",
                        \"emoji\": true
                      },
                      \"url\": \"${PR_URL}\",
                      \"style\": \"danger\"
                    }
                  ]
                }
              ]
            }" \
            "$SLACK_WEBHOOK_URL"

      # Step 6: Send Slack notification for high severity
      - name: Send Slack alert for high
        if: steps.categorize.outputs.high_count != '0' && steps.categorize.outputs.high_count != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping alert"
            exit 0
          fi

          HIGH_COUNT=${{ steps.categorize.outputs.high_count }}
          PR_URL="${{ steps.create-pr.outputs.pull-request-url }}"

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"âš ï¸ High Severity CVE Alert\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*${HIGH_COUNT} High Severity CVE(s)* detected (CVSS 7.0-8.9)\\n\\nNew pickle deserialization vulnerabilities found.\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"Review PR\",
                        \"emoji\": true
                      },
                      \"url\": \"${PR_URL}\"
                    }
                  ]
                }
              ]
            }" \
            "$SLACK_WEBHOOK_URL"

      # Step 7: Create summary
      - name: Create workflow summary
        if: steps.fetch.outputs.has_cves == 'true'
        run: |
          echo "## CVE Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Days Scanned:** ${{ github.event.inputs.days_back || '7' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.categorize.outputs.has_critical_high }}" == "true" ]; then
            echo "### New Critical/High CVEs Added" >> $GITHUB_STEP_SUMMARY
            echo "- Critical: ${{ steps.categorize.outputs.critical_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- High: ${{ steps.categorize.outputs.high_count }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**PR Created:** ${{ steps.create-pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "No new critical/high severity CVEs found." >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.categorize.outputs.has_lower }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Lower Severity CVEs" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.categorize.outputs.lower_count }} lower severity CVEs detected (not auto-added)." >> $GITHUB_STEP_SUMMARY
          fi

      # Step 8: Upload artifacts
      - name: Upload CVE data
        if: steps.fetch.outputs.has_cves == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cve-scan-${{ github.run_id }}
          path: |
            cves.json
            dedup_result.json
            critical_high_cves.json
            lower_cves.json
          retention-days: 30

      # Step 9: Create issue for lower severity CVEs (optional review)
      - name: Create issue for lower severity
        if: steps.categorize.outputs.has_lower == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Lower Severity CVEs for Review: ${{ github.run_id }}"
          content-filepath: ./lower_cves.json
          labels: |
            low-priority
            automated
